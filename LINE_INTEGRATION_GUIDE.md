# Line Bot 連動功能說明

## 🎯 功能概述

本系統實現了與Line Bot的完整連動，讓員工可以透過Line接收加班通知並進行互動。

## 🔧 主要功能

### 1. 用戶名稱選擇
- **功能**: Line用戶可以選擇輪值表中的名稱
- **驗證**: 系統會驗證名稱是否存在於輪值表中
- **狀態管理**: 使用數據庫持久化用戶選擇狀態

### 2. 加班資格檢查
- **自動檢查**: 當用戶選定名稱後，系統自動檢查加班資格
- **智能通知**: 只通知符合資格的員工
- **資格條件**:
  - 不能為自己的請假加班
  - 不能為同班同事加班
  - 大休班級優先有加班資格
  - 小休班級也可能有加班資格

### 3. 加班機會通知
- **即時通知**: 有新的加班需求時立即通知符合資格的員工
- **詳細資訊**: 包含日期、請假人員、時段、原因等
- **個人化**: 根據員工的班級和角色個人化通知內容

### 4. 加班機會消失通知
- **自動通知**: 當加班機會被取消或已有人確認時通知相關員工
- **多種情況**:
  - 請假記錄被刪除
  - 加班需求被取消
  - 其他員工已確認加班

## 📱 用戶互動指令

### 基本設定
- `選擇名稱` / `開始` - 開始設定或重新選擇名稱
- `重新選擇` / `更改名稱` - 重新選擇名稱
- `我的狀態` / `個人資訊` - 查看個人設定狀態

### 查詢功能
- `查詢加班` / `加班機會` - 查看當前可用的加班機會
- `幫助` / `help` - 顯示指令列表

## 🏗️ 技術架構

### API 端點

#### 1. `/api/line-webhook` (POST)
- **功能**: 處理Line Bot的webhook事件
- **支援事件**: 訊息、Postback、關注
- **安全性**: 驗證Line簽名

#### 2. `/api/overtime-opportunity` 
- **POST**: 通知符合資格的員工有新的加班機會
- **DELETE**: 通知加班機會已取消
- **GET**: 查詢個人的加班機會

### 數據模型

#### LineUserState
```typescript
{
  lineUserId: string;
  step: 'waiting_name_selection' | 'name_selected' | 'completed';
  selectedName?: string;
  selectedTeam?: string;
  selectedRole?: string;
  lastActivity: Date;
}
```

### 服務層

#### lineBot.ts
- 用戶狀態管理
- 訊息發送功能
- 名稱選擇處理
- 指令處理
- 加班資格檢查

## 🔄 工作流程

### 1. 用戶初次使用
```
用戶加入Bot → 發送歡迎訊息 → 引導選擇名稱 → 驗證名稱 → 設定完成
```

### 2. 加班通知流程
```
請假記錄創建 → 檢查加班需求 → 查找符合資格的員工 → 發送Line通知
```

### 3. 加班確認流程
```
員工確認加班 → 更新記錄 → 通知其他員工機會已消失
```

### 4. 加班取消流程
```
請假取消/記錄刪除 → 發送取消通知給所有相關員工
```

## ⚙️ 設定要求

### 環境變數
```env
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token
LINE_CHANNEL_SECRET=your_channel_secret
NEXTAUTH_URL=your_app_url
```

### Line Bot 設定
1. **Webhook URL**: `https://your-domain.com/api/line-webhook`
2. **事件類型**: 
   - 訊息事件
   - Postback事件
   - 關注/取消關注事件

## 🧪 測試功能

訪問 `/line-test` 頁面可以測試各項功能：
- Webhook端點健康檢查
- 加班機會查詢API
- 加班通知功能
- 用戶狀態管理

## 📋 使用說明

### 管理員操作
1. 設定Line Bot的Webhook URL
2. 配置環境變數
3. 部署應用程式
4. 測試各項功能

### 員工使用
1. 加入Line Bot為好友
2. 輸入「選擇名稱」開始設定
3. 從快速回覆選單選擇自己的名稱
4. 設定完成後會收到相關的加班通知
5. 可使用各種指令查詢和管理

## 🔍 監控與日誌

系統會記錄以下資訊：
- 用戶互動日誌
- 通知發送結果
- 錯誤和異常情況
- API調用統計

## 🚀 未來擴展

可考慮的功能擴展：
- 推播訊息排程
- 更豐富的互動式選單
- 加班確認直接在Line中完成
- 統計報表功能
- 多語言支援

## 📞 技術支援

如有問題請檢查：
1. Line Bot設定是否正確
2. 環境變數是否配置
3. 數據庫連接是否正常
4. 查看應用程式日誌
